name: Run tests and linting
on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
jobs:
  test:
    runs-on: ubuntu-latest   
    services:
      mongo:
        image: mongo:7.0.14
        ports:
          - 27017:27017
        options: |
          --health-cmd "mongo --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3

    steps:
      - name: Git checkout
        uses: actions/checkout@v4

      - name: Set up Docker
        run: |
          docker build -t node-app -f docker/node/Dockerfile .
          docker run -d --name node-api --link mongo:mongo -e MONGO_URI="mongodb://mongo:27017" -p 3000:3000 node-app

      - name: Wait for MongoDB to be ready
        run: |
          echo "Waiting for MongoDB to be ready..."
          sleep 20 # Donne le temps Ã  MongoDB de se lancer correctement

      - name: Run tests
        run: |
          docker exec node-app-container npx jest --coverage

      - name: Run linter
        run: npm run lint
        working-directory: ./api

      - name: Upload results to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Clean up
        run: |
          docker stop node-app-container
          docker rm node-app-container